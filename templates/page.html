<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Training Manual</title>
<!-- Modern Theme CSS (toggled via JavaScript) -->
<link rel="stylesheet" href="{{ url_for('static', filename='style-modern.css') }}" id="modern-style" disabled>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --bg: #0f0f10;
  --card: #1a1a1d;
  --text: #e8e8e8;
  --muted: #9ca3af;
  --accent: #6366f1;
  --accent-dim: #4f46e5;
  --highlight: #fbbf24;
}
html, body { height: 100%; overflow: hidden; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
  line-height: 1.7;
  display: flex;
  flex-direction: column;
}

/* Content wrapper */
.page-wrapper {
  flex: 1;
  display: flex;
  align-items: flex-start;
  justify-content: center;
  padding: 80px 20px 120px;
  position: relative;
  overflow: hidden;
  max-height: calc(100vh - 200px);
}

/* Scrollable version for cover and TOC pages */
.page-wrapper.scrollable {
  overflow-y: auto;
  max-height: calc(100vh - 120px);
  scroll-behavior: smooth;
}

.content-card {
  max-width: 1400px;
  width: 100%;
  max-height: calc(100vh - 240px);
  background: var(--card);
  border-radius: 16px;
  padding: 48px 60px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  animation: fadeIn 0.4s ease-out;
  overflow-y: auto;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  scroll-behavior: smooth;
}

/* Scrollable version for cover and TOC pages (removes max-height) */
.content-card.scrollable {
  max-height: none;
}

/* Custom scrollbar styling for all content cards */
.page-wrapper.scrollable::-webkit-scrollbar,
.content-card::-webkit-scrollbar {
  width: 8px;
}

.page-wrapper.scrollable::-webkit-scrollbar-track,
.content-card::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
}

.page-wrapper.scrollable::-webkit-scrollbar-thumb,
.content-card::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}

.page-wrapper.scrollable::-webkit-scrollbar-thumb:hover,
.content-card::-webkit-scrollbar-thumb:hover {
  background: var(--highlight);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Typography */
h1 {
  font-size: 36px;
  font-weight: 700;
  margin-bottom: 12px;
  color: var(--highlight);
  letter-spacing: -0.5px;
}

h2 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--accent);
}

h3 {
  font-size: 20px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text);
}

.subtitle {
  font-size: 18px;
  color: var(--muted);
  margin-bottom: 32px;
}

.badge {
  display: none;
}

/* Content sections */
.content-text {
  line-height: 1.8;
  font-size: 17px;
  color: var(--text);
  margin-bottom: 20px;
  flex: 1;
  overflow: visible;
}

.content-text p {
  margin-bottom: 16px;
}

.content-text strong, .content-text b {
  font-weight: 700;
  color: var(--highlight);
  display: block;
  margin-top: 24px;
  margin-bottom: 8px;
  font-size: 18px;
}

.content-text em, .content-text i {
  font-style: italic;
  color: var(--accent);
}

.content-text ul, .content-text ol {
  margin: 16px 0;
  padding-left: 24px;
}

.content-text li {
  margin: 8px 0;
}

/* Callout boxes */
.callout {
  margin: 24px 0;
  padding: 18px 22px;
  border-radius: 12px;
  border-left: 5px solid;
  animation: fadeIn 0.3s ease-out;
}

.callout-title {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.callout-content {
  font-size: 16px;
  line-height: 1.7;
}

.callout-tip {
  background: rgba(59, 130, 246, 0.12);
  border-left-color: #3b82f6;
}

.callout-tip .callout-title {
  color: #60a5fa;
}

.callout-warning {
  background: rgba(251, 191, 36, 0.12);
  border-left-color: #fbbf24;
}

.callout-warning .callout-title {
  color: #fbbf24;
}

.callout-example {
  background: rgba(16, 185, 129, 0.12);
  border-left-color: #10b981;
}

.callout-example .callout-title {
  color: #34d399;
}

.callout-key {
  background: rgba(251, 191, 36, 0.15);
  border-left-color: var(--highlight);
}

.callout-key .callout-title {
  color: var(--highlight);
}

.callout-important {
  background: rgba(239, 68, 68, 0.12);
  border-left-color: #ef4444;
}

.callout-important .callout-title {
  color: #f87171;
}

.callout-note {
  background: rgba(168, 85, 247, 0.12);
  border-left-color: #a855f7;
}

.callout-note .callout-title {
  color: #c084fc;
}

.content-text h1, .content-text h2, .content-text h3 {
  margin-top: 24px;
  margin-bottom: 12px;
}

.content-text code {
  background: rgba(99, 102, 241, 0.15);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 15px;
}

.toc-list {
  list-style: none;
  margin: 32px 0;
}

.toc-list li {
  margin: 16px 0;
  padding: 16px 20px;
  background: rgba(99, 102, 241, 0.1);
  border-left: 3px solid var(--accent);
  border-radius: 8px;
  font-size: 18px;
  transition: all 0.2s;
}

.toc-list li:hover {
  background: rgba(99, 102, 241, 0.2);
  transform: translateX(4px);
}

/* Navigation arrows */
.nav-arrows {
  position: fixed;
  bottom: 40px;
  width: 100%;
  max-width: 1400px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  justify-content: space-between;
  align-items: center;
  pointer-events: none;
  padding: 0 20px;
}

.arrow-btn {
  pointer-events: all;
  width: 56px;
  height: 56px;
  background: var(--accent);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 24px;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
}

.arrow-btn:hover:not(:disabled) {
  background: var(--accent-dim);
  transform: scale(1.1);
}

.arrow-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.center-buttons {
  pointer-events: all;
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 12px;
  align-items: center;
}

.index-btn, .glossary-btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.index-btn {
  background: var(--highlight);
  color: var(--bg);
  box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
}

.index-btn:hover {
  background: #f59e0b;
  transform: scale(1.05);
}

.glossary-btn {
  background: var(--accent);
  color: white;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.glossary-btn:hover {
  background: var(--accent-dim);
  transform: scale(1.05);
}

/* Quiz Dropdown Styles */
.quiz-dropdown {
  margin-top: 8px;
  margin-left: 30px;
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.3s ease-out;
}

.quiz-dropdown.expanded {
  max-height: 500px;
}

.quiz-toggle {
  cursor: pointer;
  user-select: none;
  font-size: 13px;
  color: var(--accent);
  margin-left: 30px;
  margin-top: 4px;
  padding: 4px 0;
  transition: color 0.2s;
}

.quiz-toggle:hover {
  color: var(--highlight);
}

.quiz-toggle-icon {
  display: inline-block;
  transition: transform 0.3s ease;
  margin-right: 4px;
}

.quiz-toggle-icon.rotated {
  transform: rotate(90deg);
}

.quiz-question-item {
  font-size: 13px;
  color: var(--muted);
  padding: 4px 0;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: color 0.2s;
}

.quiz-question-item:hover {
  color: var(--accent);
}

.quiz-question-item.answered {
  color: #10b981;
}

.quiz-question-item.answered:hover {
  color: var(--highlight);
}

.quiz-question-checkmark {
  font-size: 14px;
}

/* Enhanced Progress Bar */
.progress-container {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: rgba(26, 26, 29, 0.95);
  backdrop-filter: blur(10px);
  padding: 12px 20px;
  z-index: 100;
  border-bottom: 1px solid rgba(99, 102, 241, 0.2);
}

.progress-header {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  flex-wrap: wrap;
}

.progress-info {
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
  min-width: 300px;
}

.module-badge-header {
  background: rgba(99, 102, 241, 0.2);
  color: var(--accent);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
}

.progress-bar-wrapper {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 12px;
  min-width: 200px;
}

.progress-bar-track {
  flex: 1;
  height: 8px;
  background: rgba(99, 102, 241, 0.2);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--highlight));
  border-radius: 4px;
  transition: width 0.5s ease;
  position: relative;
  overflow: hidden;
}

.progress-bar-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.progress-text {
  color: var(--muted);
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
}

.page-counter-header {
  background: rgba(99, 102, 241, 0.15);
  color: var(--text);
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
}

/* Old progress bar - hide it */
.progress-bar {
  display: none;
}

/* Footer hint */
.keyboard-hint {
  display: none;
}

/* Page counter - now in header */
.page-counter {
  display: none;
}

/* Breadcrumb navigation - now in header */
.breadcrumb {
  display: none;
}

.breadcrumb-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  flex-wrap: wrap;
  flex: 1;
  min-width: 300px;
}

.breadcrumb-link-header {
  color: var(--accent);
  text-decoration: none;
  transition: all 0.2s;
  padding: 4px 8px;
  border-radius: 6px;
  white-space: nowrap;
}

.breadcrumb-link-header:hover {
  background: rgba(99, 102, 241, 0.15);
  color: var(--highlight);
}

.breadcrumb-sep {
  color: var(--muted);
  opacity: 0.5;
}

.breadcrumb-current-header {
  color: var(--text);
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* User Info - Aligned with Header */
.user-info-container {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-left: auto;
}

.username-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: rgba(99, 102, 241, 0.1);
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: 20px;
  font-size: 13px;
  color: var(--text);
  font-weight: 500;
}

/* Logout Button */
.quiz-manager-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  border: 1px solid rgba(245, 158, 11, 0.4);
  border-radius: 20px;
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  font-size: 13px;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
}

.quiz-manager-btn:hover {
  background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
  border-color: rgba(245, 158, 11, 0.6);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
}

.logout-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 20px;
  color: #ef4444;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  font-size: 13px;
  font-weight: 500;
}

.logout-btn:hover {
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.5);
}

/* Theme Toggle Button */
.theme-toggle {
  position: fixed;
  bottom: 24px;
  right: 24px;
  background: var(--accent);
  border: 2px solid var(--highlight);
  border-radius: 50%;
  width: 56px;
  height: 56px;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(99, 102, 241, 0.6);
  transition: all 0.3s ease;
  z-index: 1000;
  font-size: 24px;
}

.theme-toggle:hover {
  transform: scale(1.15);
  box-shadow: 0 6px 28px rgba(251, 191, 36, 0.8);
  background: var(--highlight);
  border-color: var(--accent);
}

/* Submit Quiz Button */
.submit-quiz-btn {
  min-width: 160px !important;
  white-space: nowrap;
  animation: pulse 2s ease-in-out infinite;
}

.continue-quiz-btn {
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
  }
  50% {
    box-shadow: 0 4px 20px rgba(251, 191, 36, 0.6);
  }
}

/* Continue Learning Button */
.continue-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  background: linear-gradient(135deg, var(--accent), var(--accent-dim));
  color: white;
  text-decoration: none;
  border-radius: 12px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
  border: 2px solid rgba(251, 191, 36, 0.3);
  white-space: nowrap;
  animation: pulse-continue 3s ease-in-out infinite;
}

.continue-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 24px rgba(99, 102, 241, 0.5);
  border-color: var(--highlight);
}

@keyframes pulse-continue {
  0%, 100% {
    box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
  }
  50% {
    box-shadow: 0 6px 24px rgba(251, 191, 36, 0.5);
  }
}
</style>
</head>
<body>

<!-- Enhanced Progress Header -->
<div class="progress-container">
  <div class="progress-header">
    <!-- Breadcrumb Navigation in Header -->
    <div class="breadcrumb-header">
      {% if page.type != 'cover' %}
        <a href="{{ url_for('page', page_num=1) }}" class="breadcrumb-link-header">üìë TOC</a>
        
        {% if page.type == 'intro' %}
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Ch {{ page.chapter_id }}: {{ page.chapter_title }}</span>
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Intro</span>
        
        {% elif page.type == 'module' %}
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Ch {{ page.chapter_id }}: {{ page.chapter_title }}</span>
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Module {{ page.module_id }}</span>
          {% if page.module_total_pages > 1 %}
            <span class="breadcrumb-sep">‚Ä∫</span>
            <span class="breadcrumb-current-header">Page {{ page.module_page_num }}/{{ page.module_total_pages }}</span>
          {% endif %}
        
        {% elif page.type == 'quiz' %}
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Ch {{ page.chapter_id }}</span>
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Module {{ page.module_id }}</span>
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Quiz {{ page.question_number }}/{{ page.total_questions }}</span>
        
        {% elif page.type == 'summary' %}
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Ch {{ page.chapter_id }}: {{ page.chapter_title }}</span>
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Summary</span>
        
        {% elif page.type == 'action_items' %}
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Ch {{ page.chapter_id }}: {{ page.chapter_title }}</span>
          <span class="breadcrumb-sep">‚Ä∫</span>
          <span class="breadcrumb-current-header">Action Items</span>
        
        {% elif page.type == 'toc' %}
          <span class="breadcrumb-current-header">Table of Contents</span>
        {% endif %}
      {% else %}
        <span class="breadcrumb-current-header">Welcome</span>
      {% endif %}
    </div>
    
    <!-- Chapter Progress -->
    <div class="progress-info">
      {% if page.type == 'module' or page.type == 'quiz' %}
        {% set chapter_id = page.chapter_id %}
        {% if chapter_id == 1 %}
          {% set chapter_modules = ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6'] %}
        {% elif chapter_id == 2 %}
          {% set chapter_modules = ['2.1', '2.2', '2.3', '2.4', '2.5', '2.6', '2.7', '2.8', '2.9'] %}
        {% elif chapter_id == 3 %}
          {% set chapter_modules = ['3.1', '3.2', '3.3', '3.4'] %}
        {% elif chapter_id == 4 %}
          {% set chapter_modules = ['4.1', '4.2', '4.3', '4.4', '4.5'] %}
        {% elif chapter_id == 5 %}
          {% set chapter_modules = ['5.1', '5.2', '5.3', '5.4', '5.5', '5.6'] %}
        {% elif chapter_id == 6 %}
          {% set chapter_modules = ['6.1', '6.2', '6.3', '6.4'] %}
        {% else %}
          {% set chapter_modules = [] %}
        {% endif %}
        
        {% set current_module_id = page.module_id|string %}
        {% set module_index = chapter_modules.index(current_module_id) + 1 if current_module_id in chapter_modules else 0 %}
        {% set total_modules = chapter_modules|length %}
        {% set progress_percent = (module_index / total_modules * 100) if total_modules > 0 else 0 %}
        
        <div class="module-badge-header">Chapter {{ chapter_id }} Progress</div>
        <div class="progress-bar-wrapper">
          <div class="progress-bar-track">
            <div class="progress-bar-fill" style="width: {{ progress_percent }}%;"></div>
          </div>
          <span class="progress-text">Module {{ module_index }} of {{ total_modules }}</span>
        </div>
      {% elif page.type == 'intro' or page.type == 'summary' or page.type == 'action_items' %}
        {% set chapter_id = page.chapter_id %}
        <div class="module-badge-header">Chapter {{ chapter_id }}</div>
      {% elif page.type == 'toc' %}
        <div class="module-badge-header">Table of Contents</div>
      {% elif page.type == 'cover' %}
        <div class="module-badge-header">Welcome</div>
      {% endif %}
      
      {% if preview_mode %}
        <div style="background: rgba(251, 191, 36, 0.2); border: 1px solid var(--highlight); padding: 6px 14px; border-radius: 20px; font-size: 13px; color: var(--highlight); font-weight: 600; margin-left: auto;">
          üîì Preview
        </div>
      {% endif %}
    </div>
    
    <!-- User Info - Aligned with Header -->
    {% if session.get('logged_in') and session.get('username') %}
    <div class="user-info-container">
      <div class="username-badge">
        <span>üë§ {{ session.get('username') }}</span>
      </div>
      <a href="{{ url_for('quiz_questions') }}" class="quiz-manager-btn">
        <span>üìù Quiz Manager</span>
      </a>
      <a href="{{ url_for('logout') }}" class="logout-btn">
        <span>Log Out</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
      </a>
    </div>
    {% endif %}
  </div>
</div>

<div class="page-wrapper{% if page.type == 'cover' or page.type == 'toc' %} scrollable{% endif %}">
  <div class="content-card{% if page.type == 'cover' or page.type == 'toc' %} scrollable{% endif %}">
    {% if page.type == 'cover' %}
      <div style="text-align: center; padding: 40px 0;">
        <h1 style="font-size: 56px; margin-bottom: 8px; letter-spacing: 2px;">FREIGHT AGENT</h1>
        <h1 style="font-size: 56px; margin-bottom: 40px; letter-spacing: 2px;">TRAINING MANUAL</h1>
        <div style="font-size: 22px; color: var(--accent); margin-bottom: 80px; font-weight: 500;">
          Complete Guide to Truck Brokerage Operations
        </div>
        
        <div style="text-align: left; margin-top: 60px;">
          <h2 style="font-size: 32px; margin-bottom: 32px; color: var(--highlight); text-align: center;">TABLE OF CONTENTS</h2>
          
          <div style="margin-bottom: 32px;">
            <h3 style="font-size: 20px; color: var(--accent); margin-bottom: 12px;">PART I: FOUNDATIONS</h3>
            <div style="margin-left: 20px; line-height: 2; font-size: 16px;">
              <div>Chapter 1: Welcome to Freight Brokerage</div>
              <div>Chapter 2: Understanding the Industry Landscape</div>
              <div>Chapter 3: The Role of a Freight Agent</div>
            </div>
          </div>
          
          <div style="margin-bottom: 32px;">
            <h3 style="font-size: 20px; color: var(--accent); margin-bottom: 12px;">PART II: TECHNICAL KNOWLEDGE</h3>
            <div style="margin-left: 20px; line-height: 2; font-size: 16px;">
              <div>Chapter 4: Truck Types and Specifications</div>
              <div>Chapter 5: Load Types and Cargo Categories</div>
              <div>Chapter 6: Load Restrictions and Regulations</div>
            </div>
          </div>
          
          <div style="margin-bottom: 32px;">
            <h3 style="font-size: 20px; color: var(--accent); margin-bottom: 12px;">PART III: BUSINESS DEVELOPMENT</h3>
            <div style="margin-left: 20px; line-height: 2; font-size: 16px;">
              <div>Chapter 7: Building Your Customer Base</div>
              <div>Chapter 8: Sales Strategies for Freight Agents</div>
              <div>Chapter 9: Effective Follow-Up Systems</div>
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <div style="margin-left: 20px; line-height: 2; font-size: 16px;">
              <div>Glossary</div>
              <div style="color: var(--muted); font-size: 14px; margin-left: 20px;">Important Industry Terms & Definitions</div>
            </div>
          </div>
        </div>
        
        <p style="margin-top: 60px; color: var(--muted); font-size: 15px; text-align: center;">
          Press ‚Üí to begin your journey
        </p>
      </div>
    
    {% elif page.type == 'toc' %}
      <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; flex-wrap: wrap; margin-bottom: 24px;">
        <div style="flex: 1; min-width: 300px;">
          <h1 style="margin-bottom: 8px;">Training Manual</h1>
          <div class="subtitle">Your journey to becoming a freight agent starts here.</div>
        </div>
        
        {% if not preview_mode and page.ch1_modules %}
          {# Find the next incomplete module #}
          {% set next_module = namespace(mod=None, page=None) %}
          
          {% for mod in page.ch1_modules %}
            {% if not next_module.mod and module_completion.get(mod['id']) != True %}
              {% set next_module.mod = mod %}
              {% set next_module.page = page.module_page_map.get(mod['id']) %}
            {% endif %}
          {% endfor %}
          
          {% if not next_module.mod and page.ch2_modules %}
            {% for mod in page.ch2_modules %}
              {% if not next_module.mod and module_completion.get(mod['id']) != True %}
                {% set next_module.mod = mod %}
                {% set next_module.page = page.module_page_map.get(mod['id']) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if not next_module.mod and page.ch3_modules %}
            {% for mod in page.ch3_modules %}
              {% if not next_module.mod and module_completion.get(mod['id']) != True %}
                {% set next_module.mod = mod %}
                {% set next_module.page = page.module_page_map.get(mod['id']) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if not next_module.mod and page.ch4_modules %}
            {% for mod in page.ch4_modules %}
              {% if not next_module.mod and module_completion.get(mod['id']) != True %}
                {% set next_module.mod = mod %}
                {% set next_module.page = page.module_page_map.get(mod['id']) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if not next_module.mod and page.ch5_modules %}
            {% for mod in page.ch5_modules %}
              {% if not next_module.mod and module_completion.get(mod['id']) != True %}
                {% set next_module.mod = mod %}
                {% set next_module.page = page.module_page_map.get(mod['id']) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if not next_module.mod and page.ch6_modules %}
            {% for mod in page.ch6_modules %}
              {% if not next_module.mod and module_completion.get(mod['id']) != True %}
                {% set next_module.mod = mod %}
                {% set next_module.page = page.module_page_map.get(mod['id']) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if not next_module.mod and page.ch7_modules %}
            {% for mod in page.ch7_modules %}
              {% if not next_module.mod and module_completion.get(mod['id']) != True %}
                {% set next_module.mod = mod %}
                {% set next_module.page = page.module_page_map.get(mod['id']) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if not next_module.mod and page.ch8_modules %}
            {% for mod in page.ch8_modules %}
              {% if not next_module.mod and module_completion.get(mod['id']) != True %}
                {% set next_module.mod = mod %}
                {% set next_module.page = page.module_page_map.get(mod['id']) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if not next_module.mod and page.ch9_modules %}
            {% for mod in page.ch9_modules %}
              {% if not next_module.mod and module_completion.get(mod['id']) != True %}
                {% set next_module.mod = mod %}
                {% set next_module.page = page.module_page_map.get(mod['id']) %}
              {% endif %}
            {% endfor %}
          {% endif %}
          
          {% if next_module.mod and next_module.page %}
            <a href="{{ url_for('page', page_num=next_module.page) }}" class="continue-btn">
              <span style="font-size: 18px;">‚ñ∂</span>
              <div>
                <div style="font-size: 12px; opacity: 0.9;">Continue Learning</div>
                <div style="font-size: 14px; font-weight: 600;">Module {{ next_module.mod['id'] }}</div>
              </div>
            </a>
          {% endif %}
        {% endif %}
      </div>
      
      {% if preview_mode %}
        <div style="background: rgba(251, 191, 36, 0.2); border-left: 4px solid var(--highlight); padding: 12px 16px; border-radius: 8px; margin-bottom: 20px;">
          <strong style="color: var(--highlight);">üîì Preview Mode Active</strong> - All content unlocked for review
        </div>
      {% endif %}
      
      <ul class="toc-list">
        {% for ch in page.chapters %}
          {% if ch.id == 'glossary' %}
            {# Glossary is available via button at bottom of screen #}
          {% elif ch.id == 1 %}
            <li style="cursor: pointer;">
              <a href="{{ url_for('page', page_num=2) }}" style="color: var(--text); text-decoration: none; display: block;">Chapter {{ ch.id }}: {{ ch.title }}</a>
              {% if page.ch1_modules %}
              <div style="margin-left: 30px; margin-top: 12px; font-size: 14px; line-height: 2.0;">
                {% for mod in page.ch1_modules %}
                  {% set is_complete = module_completion.get(mod.id, False) %}
                  {% set prev_index = loop.index0 - 1 %}
                  {% set is_locked = False %}
                  {% if not preview_mode %}
                    {% if loop.index0 > 0 %}
                      {% set prev_mod_id = page.ch1_modules[prev_index].id %}
                      {% set is_locked = not module_completion.get(prev_mod_id, False) %}
                    {% endif %}
                  {% endif %}
                  
                  <div style="margin: 6px 0; display: flex; align-items: center;">
                    {% if is_complete %}
                      <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    {% elif preview_mode %}
                      <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    {% else %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% endif %}
                    
                    {% if is_locked and not preview_mode %}
                      <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                        üîí Module {{ mod.id }}: {{ mod.title }}
                      </span>
                    {% else %}
                      <a href="{{ url_for('page', page_num=page.module_page_map[mod.id]) }}" 
                         style="color: {% if is_complete %}#10b981{% elif preview_mode %}var(--highlight){% else %}var(--muted){% endif %}; text-decoration: none; transition: color 0.2s;" 
                         onmouseover="this.style.color='var(--accent)'" 
                         onmouseout="this.style.color='{% if is_complete %}#10b981{% elif preview_mode %}var(--highlight){% else %}var(--muted){% endif %}'">
                        Module {{ mod.id }}: {{ mod.title }}
                      </a>
                    {% endif %}
                  </div>
                  
                  {% if is_complete and quiz_map.get(mod.id) %}
                    <div class="quiz-toggle" onclick="toggleQuizDropdown('{{ mod.id }}')">
                      <span class="quiz-toggle-icon" id="toggle-icon-{{ mod.id }}">‚ñ∂</span>
                      Quiz Questions ({{ quiz_map[mod.id]|length }})
                    </div>
                    <div class="quiz-dropdown" id="quiz-dropdown-{{ mod.id }}">
                      {% for quiz_q in quiz_map[mod.id] %}
                        {% set is_answered = quiz_answers.get(quiz_q.id, False) %}
                        {% set quiz_page_num = page.quiz_page_map.get(quiz_q.id) %}
                        <a href="{{ url_for('page', page_num=quiz_page_num) }}" 
                           class="quiz-question-item {% if is_answered %}answered{% endif %}"
                           style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                          <span class="quiz-question-checkmark">{% if is_answered %}‚úì{% else %}‚óã{% endif %}</span>
                          <span>Question {{ loop.index }}</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Chapter 1 Key Concepts (locked until all modules complete) -->
                <div style="margin: 12px 0 6px; display: flex; align-items: center;">
                  {% if all_ch1_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=25) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 1 Key Concepts
                    </a>
                  {% elif preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=25) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 1 Key Concepts
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 1 Key Concepts
                    </span>
                  {% endif %}
                </div>
                
                <!-- Chapter 1 Action Items (locked until all modules complete) -->
                <div style="margin: 6px 0; display: flex; align-items: center;">
                  {% if all_ch1_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=26) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 1 Action Items
                    </a>
                  {% elif preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=26) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 1 Action Items
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 1 Action Items
                    </span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </li>
          {% elif ch.id == 2 %}
            <li style="cursor: pointer;">
              <a href="{{ url_for('page', page_num=28) }}" style="color: var(--text); text-decoration: none; display: block;">Chapter {{ ch.id }}: {{ ch.title }}</a>
              {% if page.ch2_modules %}
              <div style="margin-left: 30px; margin-top: 12px; font-size: 14px; line-height: 2.0;">
                {% for mod in page.ch2_modules %}
                  {% set is_complete = module_completion.get(mod.id, False) %}
                  {% set prev_index = loop.index0 - 1 %}
                  {% set is_locked = False %}
                  {% if not preview_mode %}
                    {% if loop.index0 > 0 %}
                      {% set prev_mod_id = page.ch2_modules[prev_index].id %}
                      {% set is_locked = not module_completion.get(prev_mod_id, False) %}
                    {% elif loop.index0 == 0 %}
                      {# First module of Chapter 2 requires Chapter 1 completion #}
                      {% set is_locked = not all_ch1_modules_complete %}
                    {% endif %}
                  {% endif %}
                  
                  <div style="margin: 6px 0; display: flex; align-items: center;">
                    {% if is_complete %}
                      <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    {% elif preview_mode %}
                      <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    {% else %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% endif %}
                    
                    {% if is_locked and not preview_mode %}
                      <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                        üîí Module {{ mod.id }}: {{ mod.title }}
                      </span>
                    {% else %}
                      <a href="{{ url_for('page', page_num=page.module_page_map[mod.id]) }}" 
                         style="color: {% if is_complete %}#10b981{% elif preview_mode %}var(--highlight){% else %}var(--muted){% endif %}; text-decoration: none; transition: color 0.2s;" 
                         onmouseover="this.style.color='var(--accent)'" 
                         onmouseout="this.style.color='{% if is_complete %}#10b981{% elif preview_mode %}var(--highlight){% else %}var(--muted){% endif %}'">
                        Module {{ mod.id }}: {{ mod.title }}
                      </a>
                    {% endif %}
                  </div>
                  
                  {% if is_complete and quiz_map.get(mod.id) %}
                    <div class="quiz-toggle" onclick="toggleQuizDropdown('{{ mod.id }}')">
                      <span class="quiz-toggle-icon" id="toggle-icon-{{ mod.id }}">‚ñ∂</span>
                      Quiz Questions ({{ quiz_map[mod.id]|length }})
                    </div>
                    <div class="quiz-dropdown" id="quiz-dropdown-{{ mod.id }}">
                      {% for quiz_q in quiz_map[mod.id] %}
                        {% set is_answered = quiz_answers.get(quiz_q.id, False) %}
                        {% set quiz_page_num = page.quiz_page_map.get(quiz_q.id) %}
                        <a href="{{ url_for('page', page_num=quiz_page_num) }}" 
                           class="quiz-question-item {% if is_answered %}answered{% endif %}"
                           style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                          <span class="quiz-question-checkmark">{% if is_answered %}‚úì{% else %}‚óã{% endif %}</span>
                          <span>Question {{ loop.index }}</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Chapter 2 Key Concepts (locked until all modules complete) -->
                <div style="margin: 12px 0 6px; display: flex; align-items: center;">
                  {% if all_ch2_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 2 Key Concepts
                    </a>
                  {% elif preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 2 Key Concepts
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 2 Key Concepts
                    </span>
                  {% endif %}
                </div>
                
                <!-- Chapter 2 Action Items (locked until all modules complete) -->
                <div style="margin: 6px 0; display: flex; align-items: center;">
                  {% if all_ch2_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 2 Action Items
                    </a>
                  {% elif preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 2 Action Items
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 2 Action Items
                    </span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </li>
          {% elif ch.id == 3 %}
            <li style="cursor: pointer;">
              <a href="{{ url_for('page', page_num=total_pages - 2) }}" style="color: var(--text); text-decoration: none; display: block;">Chapter {{ ch.id }}: {{ ch.title }}</a>
              {% if page.ch3_modules %}
              <div style="margin-left: 30px; margin-top: 12px; font-size: 14px; line-height: 2.0;">
                {% for mod in page.ch3_modules %}
                  {% set is_complete = module_completion.get(mod.id, False) %}
                  {% set prev_index = loop.index0 - 1 %}
                  {% set is_locked = False %}
                  {% if not preview_mode %}
                    {% if loop.index0 > 0 %}
                      {% set prev_mod_id = page.ch3_modules[prev_index].id %}
                      {% set is_locked = not module_completion.get(prev_mod_id, False) %}
                    {% elif loop.index0 == 0 %}
                      {# First module of Chapter 3 requires Chapter 2 completion #}
                      {% set is_locked = not all_ch2_modules_complete %}
                    {% endif %}
                  {% endif %}
                  
                  <div style="margin: 6px 0; display: flex; align-items: center;">
                    {% if is_complete %}
                      <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    {% elif preview_mode %}
                      <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    {% else %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% endif %}
                    
                    {% if is_locked and not preview_mode %}
                      <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                        üîí Module {{ mod.id }}: {{ mod.title }}
                      </span>
                    {% else %}
                      <a href="{{ url_for('page', page_num=page.module_page_map[mod.id]) }}" 
                         style="color: {% if is_complete %}#10b981{% elif preview_mode %}var(--highlight){% else %}var(--muted){% endif %}; text-decoration: none; transition: color 0.2s;" 
                         onmouseover="this.style.color='var(--accent)'" 
                         onmouseout="this.style.color='{% if is_complete %}#10b981{% elif preview_mode %}var(--highlight){% else %}var(--muted){% endif %}'">
                        Module {{ mod.id }}: {{ mod.title }}
                      </a>
                    {% endif %}
                  </div>
                  
                  {% if is_complete and quiz_map.get(mod.id) %}
                    <div class="quiz-toggle" onclick="toggleQuizDropdown('{{ mod.id }}')">
                      <span class="quiz-toggle-icon" id="toggle-icon-{{ mod.id }}">‚ñ∂</span>
                      Quiz Questions ({{ quiz_map[mod.id]|length }})
                    </div>
                    <div class="quiz-dropdown" id="quiz-dropdown-{{ mod.id }}">
                      {% for quiz_q in quiz_map[mod.id] %}
                        {% set is_answered = quiz_answers.get(quiz_q.id, False) %}
                        {% set quiz_page_num = page.quiz_page_map.get(quiz_q.id) %}
                        <a href="{{ url_for('page', page_num=quiz_page_num) }}" 
                           class="quiz-question-item {% if is_answered %}answered{% endif %}"
                           style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                          <span class="quiz-question-checkmark">{% if is_answered %}‚úì{% else %}‚óã{% endif %}</span>
                          <span>Question {{ loop.index }}</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Chapter 3 Key Concepts (locked until all modules complete) -->
                <div style="margin: 12px 0 6px; display: flex; align-items: center;">
                  {% if all_ch3_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 3 Key Concepts
                    </a>
                  {% elif preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 3 Key Concepts
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 3 Key Concepts
                    </span>
                  {% endif %}
                </div>
                
                <!-- Chapter 3 Action Items (locked until all modules complete) -->
                <div style="margin: 6px 0; display: flex; align-items: center;">
                  {% if all_ch3_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 3 Action Items
                    </a>
                  {% elif preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 3 Action Items
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 3 Action Items
                    </span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </li>
          {% elif ch.id == 4 %}
            <li style="cursor: pointer;">
              <a href="{{ url_for('page', page_num=total_pages - 2) }}" style="color: var(--text); text-decoration: none; display: block;">Chapter {{ ch.id }}: {{ ch.title }}</a>
              {% if page.ch4_modules %}
              <div style="margin-left: 30px; margin-top: 12px; font-size: 14px; line-height: 2.0;">
                {% for mod in page.ch4_modules %}
                  {% set is_complete = module_completion.get(mod.id, False) %}
                  {% set prev_index = loop.index0 - 1 %}
                  {% set is_locked = False %}
                  {% if not preview_mode %}
                    {% if loop.index0 > 0 %}
                      {% set prev_mod_id = page.ch4_modules[prev_index].id %}
                      {% set is_locked = not module_completion.get(prev_mod_id, False) %}
                    {% elif loop.index0 == 0 %}
                      {# First module of Chapter 4 requires Chapter 3 completion #}
                      {% set is_locked = not all_ch3_modules_complete %}
                    {% endif %}
                  {% endif %}
                  
                  <div style="margin: 6px 0; display: flex; align-items: center;">
                    {% if preview_mode %}
                      <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    {% elif is_complete %}
                      <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    {% else %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% endif %}
                    
                    {% if is_locked and not preview_mode %}
                      <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                        üîí Module {{ mod.id }}: {{ mod.title }}
                      </span>
                    {% else %}
                      <a href="{{ url_for('page', page_num=page.module_page_map[mod.id]) }}" 
                         style="color: {% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}; text-decoration: none; transition: color 0.2s;" 
                         onmouseover="this.style.color='var(--accent)'" 
                         onmouseout="this.style.color='{% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}'">
                        Module {{ mod.id }}: {{ mod.title }}
                      </a>
                    {% endif %}
                  </div>
                  
                  {% if is_complete and quiz_map.get(mod.id) %}
                    <div class="quiz-toggle" onclick="toggleQuizDropdown('{{ mod.id }}')">
                      <span class="quiz-toggle-icon" id="toggle-icon-{{ mod.id }}">‚ñ∂</span>
                      Quiz Questions ({{ quiz_map[mod.id]|length }})
                    </div>
                    <div class="quiz-dropdown" id="quiz-dropdown-{{ mod.id }}">
                      {% for quiz_q in quiz_map[mod.id] %}
                        {% set is_answered = quiz_answers.get(quiz_q.id, False) %}
                        {% set quiz_page_num = page.quiz_page_map.get(quiz_q.id) %}
                        <a href="{{ url_for('page', page_num=quiz_page_num) }}" 
                           class="quiz-question-item {% if is_answered %}answered{% endif %}"
                           style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                          <span class="quiz-question-checkmark">{% if is_answered %}‚úì{% else %}‚óã{% endif %}</span>
                          <span>Question {{ loop.index }}</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Chapter 4 Key Concepts (locked until all modules complete) -->
                <div style="margin: 12px 0 6px; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 4 Key Concepts
                    </a>
                  {% elif all_ch4_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 4 Key Concepts
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 4 Key Concepts
                    </span>
                  {% endif %}
                </div>
                
                <!-- Chapter 4 Action Items (locked until all modules complete) -->
                <div style="margin: 6px 0; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 4 Action Items
                    </a>
                  {% elif all_ch4_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 4 Action Items
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 4 Action Items
                    </span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </li>
          {% elif ch.id == 5 %}
            <li style="cursor: pointer;">
              <a href="{{ url_for('page', page_num=total_pages - 2) }}" style="color: var(--text); text-decoration: none; display: block;">Chapter {{ ch.id }}: {{ ch.title }}</a>
              {% if page.ch5_modules %}
              <div style="margin-left: 30px; margin-top: 12px; font-size: 14px; line-height: 2.0;">
                {% for mod in page.ch5_modules %}
                  {% set is_complete = module_completion.get(mod.id, False) %}
                  {% set prev_index = loop.index0 - 1 %}
                  {% set is_locked = False %}
                  {% if not preview_mode %}
                    {% if loop.index0 > 0 %}
                      {% set prev_mod_id = page.ch5_modules[prev_index].id %}
                      {% set is_locked = not module_completion.get(prev_mod_id, False) %}
                    {% elif loop.index0 == 0 %}
                      {# First module of Chapter 5 requires Chapter 4 completion #}
                      {% set is_locked = not all_ch4_modules_complete %}
                    {% endif %}
                  {% endif %}
                  
                  <div style="margin: 6px 0; display: flex; align-items: center;">
                    {% if preview_mode %}
                      <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    {% elif is_complete %}
                      <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    {% else %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% endif %}
                    
                    {% if is_locked and not preview_mode %}
                      <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                        üîí Module {{ mod.id }}: {{ mod.title }}
                      </span>
                    {% else %}
                      <a href="{{ url_for('page', page_num=page.module_page_map[mod.id]) }}" 
                         style="color: {% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}; text-decoration: none; transition: color 0.2s;" 
                         onmouseover="this.style.color='var(--accent)'" 
                         onmouseout="this.style.color='{% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}'">
                        Module {{ mod.id }}: {{ mod.title }}
                      </a>
                    {% endif %}
                  </div>
                  
                  {% if is_complete and quiz_map.get(mod.id) %}
                    <div class="quiz-toggle" onclick="toggleQuizDropdown('{{ mod.id }}')">
                      <span class="quiz-toggle-icon" id="toggle-icon-{{ mod.id }}">‚ñ∂</span>
                      Quiz Questions ({{ quiz_map[mod.id]|length }})
                    </div>
                    <div class="quiz-dropdown" id="quiz-dropdown-{{ mod.id }}">
                      {% for quiz_q in quiz_map[mod.id] %}
                        {% set is_answered = quiz_answers.get(quiz_q.id, False) %}
                        {% set quiz_page_num = page.quiz_page_map.get(quiz_q.id) %}
                        <a href="{{ url_for('page', page_num=quiz_page_num) }}" 
                           class="quiz-question-item {% if is_answered %}answered{% endif %}"
                           style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                          <span class="quiz-question-checkmark">{% if is_answered %}‚úì{% else %}‚óã{% endif %}</span>
                          <span>Question {{ loop.index }}</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Chapter 5 Key Concepts (locked until all modules complete) -->
                <div style="margin: 12px 0 6px; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 5 Key Concepts
                    </a>
                  {% elif all_ch5_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 5 Key Concepts
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 5 Key Concepts
                    </span>
                  {% endif %}
                </div>
                
                <!-- Chapter 5 Action Items (locked until all modules complete) -->
                <div style="margin: 6px 0; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 5 Action Items
                    </a>
                  {% elif all_ch5_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 5 Action Items
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 5 Action Items
                    </span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </li>
          {% elif ch.id == 6 %}
            <li style="cursor: pointer;">
              <a href="{{ url_for('page', page_num=total_pages - 2) }}" style="color: var(--text); text-decoration: none; display: block;">Chapter {{ ch.id }}: {{ ch.title }}</a>
              {% if page.ch6_modules %}
              <div style="margin-left: 30px; margin-top: 12px; font-size: 14px; line-height: 2.0;">
                {% for mod in page.ch6_modules %}
                  {% set is_complete = module_completion.get(mod.id, False) %}
                  {% set prev_index = loop.index0 - 1 %}
                  {% set is_locked = False %}
                  {% if not preview_mode %}
                    {# All Chapter 6 modules require Chapter 5 completion #}
                    {% if not all_ch5_modules_complete %}
                      {% set is_locked = True %}
                    {% elif loop.index0 > 0 %}
                      {% set prev_mod_id = page.ch6_modules[prev_index].id %}
                      {% set is_locked = not module_completion.get(prev_mod_id, False) %}
                    {% endif %}
                  {% endif %}
                  
                  <div style="margin: 6px 0; display: flex; align-items: center;">
                    {% if preview_mode %}
                      <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    {% elif is_locked %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% elif is_complete %}
                      <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    {% else %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% endif %}
                    
                    {% if is_locked and not preview_mode %}
                      <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                        üîí Module {{ mod.id }}: {{ mod.title }}
                      </span>
                    {% else %}
                      <a href="{{ url_for('page', page_num=page.module_page_map[mod.id]) }}" 
                         style="color: {% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}; text-decoration: none; transition: color 0.2s;" 
                         onmouseover="this.style.color='var(--accent)'" 
                         onmouseout="this.style.color='{% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}'">
                        Module {{ mod.id }}: {{ mod.title }}
                      </a>
                    {% endif %}
                  </div>
                  
                  {% if is_complete and quiz_map.get(mod.id) %}
                    <div class="quiz-toggle" onclick="toggleQuizDropdown('{{ mod.id }}')">
                      <span class="quiz-toggle-icon" id="toggle-icon-{{ mod.id }}">‚ñ∂</span>
                      Quiz Questions ({{ quiz_map[mod.id]|length }})
                    </div>
                    <div class="quiz-dropdown" id="quiz-dropdown-{{ mod.id }}">
                      {% for quiz_q in quiz_map[mod.id] %}
                        {% set is_answered = quiz_answers.get(quiz_q.id, False) %}
                        {% set quiz_page_num = page.quiz_page_map.get(quiz_q.id) %}
                        <a href="{{ url_for('page', page_num=quiz_page_num) }}" 
                           class="quiz-question-item {% if is_answered %}answered{% endif %}"
                           style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                          <span class="quiz-question-checkmark">{% if is_answered %}‚úì{% else %}‚óã{% endif %}</span>
                          <span>Question {{ loop.index }}</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Chapter 6 Key Concepts (locked until all modules complete) -->
                <div style="margin: 12px 0 6px; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 6 Key Concepts
                    </a>
                  {% elif all_ch6_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 2) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 6 Key Concepts
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 6 Key Concepts
                    </span>
                  {% endif %}
                </div>
                
                <!-- Chapter 6 Action Items (locked until all modules complete) -->
                <div style="margin: 6px 0; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 6 Action Items
                    </a>
                  {% elif all_ch6_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=total_pages - 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 6 Action Items
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 6 Action Items
                    </span>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </li>
          {% elif ch.id == 7 %}
            <li style="cursor: pointer;">
              <a href="{{ url_for('page', page_num=page.module_page_map.get(page.ch7_modules[0].id) if page.ch7_modules else 1) }}" style="color: var(--text); text-decoration: none; display: block;">Chapter {{ ch.id }}: {{ ch.title }}</a>
              {% if page.ch7_modules %}
              <div style="margin-left: 30px; margin-top: 12px; font-size: 14px; line-height: 2.0;">
                {% for mod in page.ch7_modules %}
                  {% set is_complete = module_completion.get(mod.id, False) %}
                  {% set prev_index = loop.index0 - 1 %}
                  {% set is_locked = False %}
                  {% if not preview_mode %}
                    {# All Chapter 7 modules require Chapter 6 completion #}
                    {% if not all_ch6_modules_complete %}
                      {% set is_locked = True %}
                    {% elif loop.index0 > 0 %}
                      {% set prev_mod_id = page.ch7_modules[prev_index].id %}
                      {% set is_locked = not module_completion.get(prev_mod_id, False) %}
                    {% endif %}
                  {% endif %}
                  
                  <div style="margin: 6px 0; display: flex; align-items: center;">
                    {% if preview_mode %}
                      <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    {% elif is_locked %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% elif is_complete %}
                      <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    {% else %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% endif %}
                    
                    {% if is_locked and not preview_mode %}
                      <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                        üîí Module {{ mod.id }}: {{ mod.title }}
                      </span>
                    {% else %}
                      <a href="{{ url_for('page', page_num=page.module_page_map[mod.id]) }}" 
                         style="color: {% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}; text-decoration: none; transition: color 0.2s;" 
                         onmouseover="this.style.color='var(--accent)'" 
                         onmouseout="this.style.color='{% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}'">
                        Module {{ mod.id }}: {{ mod.title }}
                      </a>
                    {% endif %}
                  </div>
                  
                  {% if is_complete and quiz_map.get(mod.id) %}
                    <div class="quiz-toggle" onclick="toggleQuizDropdown('{{ mod.id }}')">
                      <span class="quiz-toggle-icon" id="toggle-icon-{{ mod.id }}">‚ñ∂</span>
                      Quiz Questions ({{ quiz_map[mod.id]|length }})
                    </div>
                    <div class="quiz-dropdown" id="quiz-dropdown-{{ mod.id }}">
                      {% for quiz_q in quiz_map[mod.id] %}
                        {% set is_answered = quiz_answers.get(quiz_q.id, False) %}
                        {% set quiz_page_num = page.quiz_page_map.get(quiz_q.id) %}
                        <a href="{{ url_for('page', page_num=quiz_page_num) }}" 
                           class="quiz-question-item {% if is_answered %}answered{% endif %}"
                           style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                          <span class="quiz-question-checkmark">{% if is_answered %}‚úì{% else %}‚óã{% endif %}</span>
                          <span>Question {{ loop.index }}</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Chapter 7 Key Concepts (locked until all modules complete) -->
                {% if page.summary_page_map and page.summary_page_map.get(7) %}
                <div style="margin: 12px 0 6px; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=page.summary_page_map[7] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 7 Key Concepts
                    </a>
                  {% elif all_ch7_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=page.summary_page_map[7] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 7 Key Concepts
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 7 Key Concepts
                    </span>
                  {% endif %}
                </div>
                {% endif %}
                
                <!-- Chapter 7 Action Items (locked until all modules complete) -->
                {% if page.action_items_page_map and page.action_items_page_map.get(7) %}
                <div style="margin: 6px 0; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=page.action_items_page_map[7] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 7 Action Items
                    </a>
                  {% elif all_ch7_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=page.action_items_page_map[7] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 7 Action Items
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 7 Action Items
                    </span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}
            </li>
          {% elif ch.id == 8 %}
            <li style="cursor: pointer;">
              <a href="{{ url_for('page', page_num=page.module_page_map.get(page.ch8_modules[0].id) if page.ch8_modules else 1) }}" style="color: var(--text); text-decoration: none; display: block;">Chapter {{ ch.id }}: {{ ch.title }}</a>
              {% if page.ch8_modules %}
              <div style="margin-left: 30px; margin-top: 12px; font-size: 14px; line-height: 2.0;">
                {% for mod in page.ch8_modules %}
                  {% set is_complete = module_completion.get(mod.id, False) %}
                  {% set prev_index = loop.index0 - 1 %}
                  {% set is_locked = False %}
                  {% if not preview_mode %}
                    {# All Chapter 8 modules require Chapter 7 completion #}
                    {% if not all_ch7_modules_complete %}
                      {% set is_locked = True %}
                    {% elif loop.index0 > 0 %}
                      {% set prev_mod_id = page.ch8_modules[prev_index].id %}
                      {% set is_locked = not module_completion.get(prev_mod_id, False) %}
                    {% endif %}
                  {% endif %}
                  
                  <div style="margin: 6px 0; display: flex; align-items: center;">
                    {% if preview_mode %}
                      <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    {% elif is_locked %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% elif is_complete %}
                      <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    {% else %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% endif %}
                    
                    {% if is_locked and not preview_mode %}
                      <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                        üîí Module {{ mod.id }}: {{ mod.title }}
                      </span>
                    {% else %}
                      <a href="{{ url_for('page', page_num=page.module_page_map[mod.id]) }}" 
                         style="color: {% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}; text-decoration: none; transition: color 0.2s;" 
                         onmouseover="this.style.color='var(--accent)'" 
                         onmouseout="this.style.color='{% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}'">
                        Module {{ mod.id }}: {{ mod.title }}
                      </a>
                    {% endif %}
                  </div>
                  
                  {% if is_complete and quiz_map.get(mod.id) %}
                    <div class="quiz-toggle" onclick="toggleQuizDropdown('{{ mod.id }}')">
                      <span class="quiz-toggle-icon" id="toggle-icon-{{ mod.id }}">‚ñ∂</span>
                      Quiz Questions ({{ quiz_map[mod.id]|length }})
                    </div>
                    <div class="quiz-dropdown" id="quiz-dropdown-{{ mod.id }}">
                      {% for quiz_q in quiz_map[mod.id] %}
                        {% set is_answered = quiz_answers.get(quiz_q.id, False) %}
                        {% set quiz_page_num = page.quiz_page_map.get(quiz_q.id) %}
                        <a href="{{ url_for('page', page_num=quiz_page_num) }}" 
                           class="quiz-question-item {% if is_answered %}answered{% endif %}"
                           style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                          <span class="quiz-question-checkmark">{% if is_answered %}‚úì{% else %}‚óã{% endif %}</span>
                          <span>Question {{ loop.index }}</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Chapter 8 Key Concepts (locked until all modules complete) -->
                {% if page.summary_page_map and page.summary_page_map.get(8) %}
                <div style="margin: 12px 0 6px; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=page.summary_page_map[8] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 8 Key Concepts
                    </a>
                  {% elif all_ch8_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=page.summary_page_map[8] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 8 Key Concepts
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 8 Key Concepts
                    </span>
                  {% endif %}
                </div>
                {% endif %}
                
                <!-- Chapter 8 Action Items (locked until all modules complete) -->
                {% if page.action_items_page_map and page.action_items_page_map.get(8) %}
                <div style="margin: 6px 0; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=page.action_items_page_map[8] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 8 Action Items
                    </a>
                  {% elif all_ch8_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=page.action_items_page_map[8] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 8 Action Items
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 8 Action Items
                    </span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}
            </li>
          {% elif ch.id == 9 %}
            <li style="cursor: pointer;">
              <a href="{{ url_for('page', page_num=page.module_page_map.get(page.ch9_modules[0].id) if page.ch9_modules else 1) }}" style="color: var(--text); text-decoration: none; display: block;">Chapter {{ ch.id }}: {{ ch.title }}</a>
              {% if page.ch9_modules %}
              <div style="margin-left: 30px; margin-top: 12px; font-size: 14px; line-height: 2.0;">
                {% for mod in page.ch9_modules %}
                  {% set is_complete = module_completion.get(mod.id, False) %}
                  {% set prev_index = loop.index0 - 1 %}
                  {% set is_locked = False %}
                  {% if not preview_mode %}
                    {# All Chapter 9 modules require Chapter 8 completion #}
                    {% if not all_ch8_modules_complete %}
                      {% set is_locked = True %}
                    {% elif loop.index0 > 0 %}
                      {% set prev_mod_id = page.ch9_modules[prev_index].id %}
                      {% set is_locked = not module_completion.get(prev_mod_id, False) %}
                    {% endif %}
                  {% endif %}
                  
                  <div style="margin: 6px 0; display: flex; align-items: center;">
                    {% if preview_mode %}
                      <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    {% elif is_locked %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% elif is_complete %}
                      <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    {% else %}
                      <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    {% endif %}
                    
                    {% if is_locked and not preview_mode %}
                      <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                        üîí Module {{ mod.id }}: {{ mod.title }}
                      </span>
                    {% else %}
                      <a href="{{ url_for('page', page_num=page.module_page_map[mod.id]) }}" 
                         style="color: {% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}; text-decoration: none; transition: color 0.2s;" 
                         onmouseover="this.style.color='var(--accent)'" 
                         onmouseout="this.style.color='{% if preview_mode %}var(--highlight){% elif is_complete %}#10b981{% else %}var(--muted){% endif %}'">
                        Module {{ mod.id }}: {{ mod.title }}
                      </a>
                    {% endif %}
                  </div>
                  
                  {% if is_complete and quiz_map.get(mod.id) %}
                    <div class="quiz-toggle" onclick="toggleQuizDropdown('{{ mod.id }}')">
                      <span class="quiz-toggle-icon" id="toggle-icon-{{ mod.id }}">‚ñ∂</span>
                      Quiz Questions ({{ quiz_map[mod.id]|length }})
                    </div>
                    <div class="quiz-dropdown" id="quiz-dropdown-{{ mod.id }}">
                      {% for quiz_q in quiz_map[mod.id] %}
                        {% set is_answered = quiz_answers.get(quiz_q.id, False) %}
                        {% set quiz_page_num = page.quiz_page_map.get(quiz_q.id) %}
                        <a href="{{ url_for('page', page_num=quiz_page_num) }}" 
                           class="quiz-question-item {% if is_answered %}answered{% endif %}"
                           style="text-decoration: none; display: flex; align-items: center; gap: 8px;">
                          <span class="quiz-question-checkmark">{% if is_answered %}‚úì{% else %}‚óã{% endif %}</span>
                          <span>Question {{ loop.index }}</span>
                        </a>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
                
                <!-- Chapter 9 Key Concepts (locked until all modules complete) -->
                {% if page.summary_page_map and page.summary_page_map.get(9) %}
                <div style="margin: 12px 0 6px; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=page.summary_page_map[9] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 9 Key Concepts
                    </a>
                  {% elif all_ch9_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=page.summary_page_map[9] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      üìã Chapter 9 Key Concepts
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 9 Key Concepts
                    </span>
                  {% endif %}
                </div>
                {% endif %}
                
                <!-- Chapter 9 Action Items (locked until all modules complete) -->
                {% if page.action_items_page_map and page.action_items_page_map.get(9) %}
                <div style="margin: 6px 0; display: flex; align-items: center;">
                  {% if preview_mode %}
                    <span style="color: var(--highlight); margin-right: 8px; font-size: 16px;">üîì</span>
                    <a href="{{ url_for('page', page_num=page.action_items_page_map[9] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;"
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 9 Action Items
                    </a>
                  {% elif all_ch9_modules_complete %}
                    <span style="color: #10b981; margin-right: 8px; font-size: 16px;">‚úì</span>
                    <a href="{{ url_for('page', page_num=page.action_items_page_map[9] + 1) }}" 
                       style="color: var(--highlight); text-decoration: none; transition: color 0.2s; font-weight: 600;" 
                       onmouseover="this.style.color='var(--accent)'" 
                       onmouseout="this.style.color='var(--highlight)'">
                      ‚úÖ Chapter 9 Action Items
                    </a>
                  {% else %}
                    <span style="color: var(--muted); margin-right: 8px; font-size: 16px;">‚òê</span>
                    <span style="color: var(--muted); opacity: 0.5; cursor: not-allowed;">
                      üîí Chapter 9 Action Items
                    </span>
                  {% endif %}
                </div>
                {% endif %}
              </div>
              {% endif %}
            </li>
          {% else %}
            <li>Chapter {{ ch.id }}: {{ ch.title }}</li>
          {% endif %}
        {% endfor %}
      </ul>
      <p class="content-text" style="margin-top: 40px; color: var(--muted);">
        Use arrow keys or buttons to navigate. Take your time with each section.
      </p>
    
    {% elif page.type == 'intro' %}
      <span class="badge">Chapter {{ page.chapter_id }}: {{ page.chapter_title }}</span>
      <h2>Introduction</h2>
      <div class="content-text">{{ page.content_html | safe }}</div>
    
    {% elif page.type == 'module' %}
      <span class="badge">Module {{ page.module_id }}</span>
      <h2>{{ page.module_title }}</h2>
      <div class="content-text">{{ page.content_html | safe }}</div>
    
    {% elif page.type == 'summary' %}
      <span class="badge">Chapter {{ page.chapter_id }} Key Concepts</span>
      <h2>Key Concepts</h2>
      <div class="content-text">{{ page.content_html | safe }}</div>
    
    {% elif page.type == 'action_items' %}
      <span class="badge">Chapter {{ page.chapter_id }} Action Items</span>
      <h2>Your Next Steps</h2>
      <div class="content-text">{{ page.content_html | safe }}</div>
    
    {% elif page.type == 'quiz' %}
      <span class="badge">Module {{ page.module_id }} - Question {{ page.question_number }} of {{ page.total_questions }}</span>
      <h2>Knowledge Check</h2>
      
      {% if quiz_answered and not quiz_feedback %}
        {# Already answered correctly in a previous session #}
        <div style="background: rgba(34, 197, 94, 0.2); border-left: 4px solid #22c55e; padding: 16px 20px; border-radius: 8px; margin-bottom: 24px;">
          <div style="color: #22c55e; font-weight: 600; margin-bottom: 8px;">‚úì Already Completed</div>
          <div style="color: var(--text); margin-bottom: 16px;">{{ page.quiz_question.explanation }}</div>
          
          {% if page.question_number < page.total_questions %}
            <a href="{{ url_for('page', page_num=page_num + 1) }}" 
               style="display: inline-block; padding: 12px 24px; background: #22c55e; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s;"
               onmouseover="this.style.background='#16a34a'; this.style.transform='scale(1.05)'"
               onmouseout="this.style.background='#22c55e'; this.style.transform='scale(1)'">
              Next Question ‚Üí
            </a>
          {% else %}
            <div style="margin-top: 8px; padding: 12px 16px; background: rgba(34, 197, 94, 0.3); border-radius: 8px; color: #22c55e; font-weight: 600;">
              üéâ Module {{ page.module_id }} questions complete! Use the arrow to continue.
            </div>
          {% endif %}
        </div>
      {% endif %}
      
      {% if quiz_feedback %}
        {% if quiz_feedback.correct %}
          <div style="background: rgba(34, 197, 94, 0.2); border-left: 4px solid #22c55e; padding: 16px 20px; border-radius: 8px; margin-bottom: 24px;">
            <div style="color: #22c55e; font-weight: 600; margin-bottom: 8px;">‚úì Correct!</div>
            <div style="color: var(--text); margin-bottom: 16px;">{{ quiz_feedback.message }}</div>
            
            {% if page.question_number < page.total_questions %}
              <a href="{{ url_for('page', page_num=page_num + 1) }}" 
                 style="display: inline-block; padding: 12px 24px; background: #22c55e; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.2s;"
                 onmouseover="this.style.background='#16a34a'; this.style.transform='scale(1.05)'"
                 onmouseout="this.style.background='#22c55e'; this.style.transform='scale(1)'">
                Next Question ‚Üí
              </a>
            {% else %}
              <div style="margin-top: 8px; padding: 12px 16px; background: rgba(34, 197, 94, 0.3); border-radius: 8px; color: #22c55e; font-weight: 600;">
                üéâ Module {{ page.module_id }} questions complete! Use the arrow to continue.
              </div>
            {% endif %}
          </div>
        {% else %}
          <div style="background: rgba(239, 68, 68, 0.2); border-left: 4px solid #ef4444; padding: 16px 20px; border-radius: 8px; margin-bottom: 24px;">
            <div style="color: #ef4444; font-weight: 600; margin-bottom: 8px;">‚úó Incorrect</div>
            <div style="color: var(--text);">{{ quiz_feedback.message }}</div>
          </div>
        {% endif %}
      {% endif %}
      
      {% if not quiz_answered or (quiz_feedback and not quiz_feedback.correct) %}
        <div class="content-text" style="font-size: 19px; font-weight: 500; margin-bottom: 32px;">
          {{ page.quiz_question.question }}
        </div>
        
        <form method="POST" action="{{ url_for('page', page_num=page_num) }}" id="quiz-form-{{ page_num }}">
          <div style="display: flex; flex-direction: column; gap: 12px;">
            {% for choice in page.quiz_question.choices %}
              {% set idx = loop.index0 %}
              <label style="display: flex; align-items: center; padding: 16px 20px; background: rgba(99, 102, 241, 0.1); border: 2px solid transparent; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                     onmouseover="this.style.background='rgba(99, 102, 241, 0.2)'; this.style.borderColor='var(--accent)'"
                     onmouseout="this.style.background='rgba(99, 102, 241, 0.1)'; this.style.borderColor='transparent'">
                <input type="radio" name="answer" value="{{ idx }}" class="quiz-choice"
                       style="width: 20px; height: 20px; margin-right: 16px; cursor: pointer;"
                       onchange="document.getElementById('quiz-warning-{{ page_num }}').style.display='none'"
                       {% if quiz_feedback and not quiz_feedback.correct and quiz_feedback.selected_index == idx %}checked{% endif %}>
                <span style="font-size: 17px;">{{ choice }}</span>
              </label>
            {% endfor %}
          </div>
        </form>
        
        {% if not quiz_answered %}
          <div id="quiz-warning-{{ page_num }}" style="display: none; margin-top: 24px; padding: 12px 16px; background: rgba(251, 191, 36, 0.15); border-radius: 8px; color: var(--highlight); font-size: 14px;">
            ‚ö†Ô∏è Please select an answer before submitting
          </div>
        {% endif %}
      {% endif %}
    
    {% else %}
      <h2>Content not found</h2>
      <p class="content-text">Please check your source file.</p>
    {% endif %}
  </div>
</div>

<div class="nav-arrows">
  {% if prev_num is not none %}
    <button class="arrow-btn" onclick="window.location.href='{{ url_for('page', page_num=prev_num) }}'">‚Üê</button>
  {% else %}
    <button class="arrow-btn" disabled>‚Üê</button>
  {% endif %}
  
  <div class="center-buttons">
    {% if page.type == 'cover' %}
      <button class="index-btn" onclick="window.location.href='{{ url_for('page', page_num=1) }}'">üöÄ Start</button>
    {% else %}
      <button class="index-btn" onclick="window.location.href='{{ url_for('page', page_num=1) }}'">üìë Index</button>
    {% endif %}
    <button class="glossary-btn" onclick="window.open('{{ url_for('glossary') }}', '_blank')">üìö Glossary</button>
  </div>
  
  {% if page.type == 'quiz' and (not quiz_answered or (quiz_feedback and not quiz_feedback.correct)) %}
    {# Replace right arrow with Submit Answer button for unanswered quizzes #}
    <button class="arrow-btn submit-quiz-btn" onclick="submitQuizAnswer({{ page_num }})" style="width: auto; padding: 0 24px; border-radius: 28px; font-size: 15px; font-weight: 600;">
      Submit Answer ‚Üí
    </button>
  {% elif page.type == 'toc' and not preview_mode %}
    {# Replace right arrow with Continue Learning button on TOC #}
    {% set next_module = namespace(mod=None, page=None) %}
    {% if page.ch1_modules %}
      {% for mod in page.ch1_modules %}
        {% if not next_module.mod and module_completion.get(mod['id']) != True %}
          {% set next_module.mod = mod %}
          {% set next_module.page = page.module_page_map.get(mod['id']) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if not next_module.mod and page.ch2_modules %}
      {% for mod in page.ch2_modules %}
        {% if not next_module.mod and module_completion.get(mod['id']) != True %}
          {% set next_module.mod = mod %}
          {% set next_module.page = page.module_page_map.get(mod['id']) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if not next_module.mod and page.ch3_modules %}
      {% for mod in page.ch3_modules %}
        {% if not next_module.mod and module_completion.get(mod['id']) != True %}
          {% set next_module.mod = mod %}
          {% set next_module.page = page.module_page_map.get(mod['id']) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if not next_module.mod and page.ch4_modules %}
      {% for mod in page.ch4_modules %}
        {% if not next_module.mod and module_completion.get(mod['id']) != True %}
          {% set next_module.mod = mod %}
          {% set next_module.page = page.module_page_map.get(mod['id']) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if not next_module.mod and page.ch5_modules %}
      {% for mod in page.ch5_modules %}
        {% if not next_module.mod and module_completion.get(mod['id']) != True %}
          {% set next_module.mod = mod %}
          {% set next_module.page = page.module_page_map.get(mod['id']) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    {% if not next_module.mod and page.ch6_modules %}
      {% for mod in page.ch6_modules %}
        {% if not next_module.mod and module_completion.get(mod['id']) != True %}
          {% set next_module.mod = mod %}
          {% set next_module.page = page.module_page_map.get(mod['id']) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if not next_module.mod and page.ch7_modules %}
      {% for mod in page.ch7_modules %}
        {% if not next_module.mod and module_completion.get(mod['id']) != True %}
          {% set next_module.mod = mod %}
          {% set next_module.page = page.module_page_map.get(mod['id']) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if not next_module.mod and page.ch8_modules %}
      {% for mod in page.ch8_modules %}
        {% if not next_module.mod and module_completion.get(mod['id']) != True %}
          {% set next_module.mod = mod %}
          {% set next_module.page = page.module_page_map.get(mod['id']) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if not next_module.mod and page.ch9_modules %}
      {% for mod in page.ch9_modules %}
        {% if not next_module.mod and module_completion.get(mod['id']) != True %}
          {% set next_module.mod = mod %}
          {% set next_module.page = page.module_page_map.get(mod['id']) %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {% if next_module.mod and next_module.page %}
      <button class="arrow-btn continue-quiz-btn" onclick="window.location.href='{{ url_for('page', page_num=next_module.page) }}'" style="width: auto; padding: 0 24px; border-radius: 28px; font-size: 15px; font-weight: 600; min-width: 180px;">
        Continue to {{ next_module.mod['id'] }} ‚Üí
      </button>
    {% elif next_num is not none %}
      <button class="arrow-btn" onclick="window.location.href='{{ url_for('page', page_num=next_num) }}'">‚Üí</button>
    {% else %}
      <button class="arrow-btn" disabled>‚Üí</button>
    {% endif %}
  {% elif next_num is not none %}
    <button class="arrow-btn" onclick="window.location.href='{{ url_for('page', page_num=next_num) }}'">‚Üí</button>
  {% else %}
    <button class="arrow-btn" disabled>‚Üí</button>
  {% endif %}
</div>

<div class="keyboard-hint">
  {% if page.type == 'quiz' and (not quiz_answered or (quiz_feedback and not quiz_feedback.correct)) %}
    Use ‚Üê to go back ‚Ä¢ ‚Üí to submit answer
  {% else %}
    Use ‚Üê ‚Üí arrow keys to navigate{% if page.type != 'cover' and page.type != 'toc' %} ‚Ä¢ No scrolling needed{% endif %}
  {% endif %}
</div>

<script>
document.addEventListener('keydown', function(e) {
  {% if prev_num is not none %}
  if (e.key === 'ArrowLeft') {
    window.location.href = "{{ url_for('page', page_num=prev_num) }}";
  }
  {% endif %}
  {% if page.type == 'quiz' and (not quiz_answered or (quiz_feedback and not quiz_feedback.correct)) %}
  if (e.key === 'ArrowRight') {
    submitQuizAnswer({{ page_num }});
  }
  {% elif page.type == 'toc' and not preview_mode %}
  {# Right arrow goes to next incomplete module on TOC #}
  {% set next_module_page_key = namespace(page=None) %}
  {% if page.ch1_modules %}
    {% for mod in page.ch1_modules %}
      {% if not next_module_page_key.page and module_completion.get(mod['id']) != True %}
        {% set next_module_page_key.page = page.module_page_map.get(mod['id']) %}
      {% endif %}
    {% endfor %}
  {% endif %}
  {% if not next_module_page_key.page and page.ch2_modules %}
    {% for mod in page.ch2_modules %}
      {% if not next_module_page_key.page and module_completion.get(mod['id']) != True %}
        {% set next_module_page_key.page = page.module_page_map.get(mod['id']) %}
      {% endif %}
    {% endfor %}
  {% endif %}
  {% if next_module_page_key.page %}
  if (e.key === 'ArrowRight') {
    window.location.href = "{{ url_for('page', page_num=next_module_page_key.page) }}";
  }
  {% endif %}
  {% elif next_num is not none %}
  if (e.key === 'ArrowRight') {
    window.location.href = "{{ url_for('page', page_num=next_num) }}";
  }
  {% endif %}
});

function submitQuizAnswer(pageNum) {
  const form = document.getElementById('quiz-form-' + pageNum);
  const warning = document.getElementById('quiz-warning-' + pageNum);
  const selectedAnswer = form.querySelector('input[name="answer"]:checked');
  
  if (!selectedAnswer) {
    // No answer selected, show warning
    if (warning) {
      warning.style.display = 'block';
      // Scroll to warning
      warning.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  } else {
    // Answer selected, submit form
    form.submit();
  }
}

function toggleQuizDropdown(moduleId) {
  const dropdown = document.getElementById('quiz-dropdown-' + moduleId);
  const icon = document.getElementById('toggle-icon-' + moduleId);
  
  if (dropdown.classList.contains('expanded')) {
    dropdown.classList.remove('expanded');
    icon.classList.remove('rotated');
  } else {
    dropdown.classList.add('expanded');
    icon.classList.add('rotated');
  }
}
</script>

<!-- Theme Toggle Script -->
<script src="{{ url_for('static', filename='theme-toggle.js') }}"></script>

</body>
</html>

