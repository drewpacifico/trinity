{% extends "base.html" %}

{% block title %}Glossary - Trinity Training Guide{% endblock %}

{% block progress %}
<!-- No progress bar on glossary page -->
{% endblock %}

{% block content %}
<div class="content-card">
    <div style="text-align: center; margin-bottom: 2rem;">
        <span style="display: inline-block; background: var(--bg); color: var(--primary); padding: 0.25rem 1rem; border-radius: 999px; font-size: 0.875rem; font-weight: 500; margin-bottom: 1rem;">
            Reference Material
        </span>
        <h1 style="border: none; padding: 0; margin-bottom: 0.5rem;">Glossary</h1>
        <p style="color: var(--text-muted); margin: 0;">Important industry terms and definitions</p>
    </div>

    <div style="margin-bottom: 1.5rem;">
        <input
            type="text"
            id="searchBox"
            placeholder="Search terms... (e.g., 'carrier', 'freight', 'regulations')"
            style="width: 100%; padding: 1rem; border: 2px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: inherit; transition: border-color 0.2s;"
            onfocus="this.style.borderColor='var(--primary)'"
            onblur="this.style.borderColor='var(--border)'"
        >
    </div>

    <div id="glossaryGrid" style="display: flex; flex-direction: column; gap: 1rem;">
        {% for term in glossary_terms %}
        {% set term_id = term.name|lower|replace(' ', '-')|replace('(', '')|replace(')', '')|replace('/', '-') %}
        <div class="glossary-term" id="{{ term_id }}" data-search="{{ term.name|lower }} {{ term.definition|lower }}" style="padding: 1.25rem; background: var(--bg); border-left: 4px solid var(--primary); border-radius: 8px; transition: all 0.2s; position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; gap: 1rem;">
                <span class="term-name" style="font-size: 1.125rem; font-weight: 600; color: var(--primary);">{{ term.name }}</span>
                <span style="font-size: 0.75rem; color: var(--text-muted); background: var(--white); padding: 0.25rem 0.75rem; border-radius: 4px; white-space: nowrap; border: 1px solid var(--border);">{{ term.module }}</span>
            </div>
            <p style="margin: 0; font-size: 0.9375rem; line-height: 1.6; color: var(--text-light);">{{ term.definition }}</p>
            <!-- Image popup container (populated by JS for equipment terms) -->
            <div class="term-image-popup" data-term-id="{{ term_id }}"></div>
        </div>
        {% endfor %}
    </div>

    <div id="noResults" style="display: none; text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
        No terms found matching your search.
    </div>

    <div style="text-align: center; color: var(--text-muted); font-size: 0.875rem; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <span id="termCount">{{ glossary_terms|length }}</span> terms total
    </div>
</div>

<style>
.glossary-term:hover {
    background: #eef1f5;
    transform: translateX(4px);
}

/* Equipment image popup styles */
.glossary-term.has-image {
    cursor: pointer;
}

.glossary-term.has-image .term-name::after {
    content: " ðŸ“·";
    font-size: 0.75rem;
    opacity: 0.6;
}

.term-image-popup {
    display: none;
    position: absolute;
    top: 0;
    right: -320px;
    width: 300px;
    background: var(--white);
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    z-index: 100;
    overflow: hidden;
    border: 1px solid var(--border);
}

.term-image-popup img {
    width: 100%;
    height: 180px;
    object-fit: cover;
}

.term-image-popup .image-caption {
    padding: 0.75rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    text-align: center;
    background: var(--bg);
    border-top: 1px solid var(--border);
}

.glossary-term.has-image:hover .term-image-popup,
.glossary-term.has-image.image-expanded .term-image-popup {
    display: block;
}

/* When image is expanded via hash link, show inline below the definition */
.glossary-term.image-expanded .term-image-popup {
    position: relative;
    right: 0;
    width: 100%;
    max-width: 400px;
    margin-top: 1rem;
}

/* Responsive: show image below on smaller screens */
@media (max-width: 900px) {
    .term-image-popup {
        position: relative;
        right: 0;
        width: 100%;
        margin-top: 1rem;
    }

    .glossary-term.has-image:hover .term-image-popup {
        display: block;
    }
}
</style>
{% endblock %}

{% block navigation %}
<nav class="bottom-nav">
    <a href="{{ url_for('toc') }}" class="nav-btn prev">
        <span>&larr;</span> Contents
    </a>

    <div class="nav-center">
        <a href="{{ url_for('cover') }}" class="nav-btn secondary">Cover</a>
    </div>

    <span class="nav-btn next disabled">
        Next <span>&rarr;</span>
    </span>
</nav>
{% endblock %}

{% block scripts %}
<script>
const searchBox = document.getElementById('searchBox');
const glossaryGrid = document.getElementById('glossaryGrid');
const noResults = document.getElementById('noResults');
const termCount = document.getElementById('termCount');
const allTerms = glossaryGrid.querySelectorAll('.glossary-term');

// Equipment terms with images
const equipmentImages = {
    'dry-van-trailer': {
        image: '/static/images/dry_van.jpeg',
        caption: 'Standard 53\' dry van trailer'
    },
    'refrigerated-trailer-reefer': {
        image: '/static/images/reefer.jpeg',
        caption: 'Refrigerated trailer (reefer) with temperature control unit'
    },
    'flatbed-trailer': {
        image: '/static/images/flatbed.jpeg',
        caption: 'Open flatbed trailer for oversized or top-loading freight'
    },
    'step-deck-drop-deck-trailer': {
        image: '/static/images/step_deck.jpeg',
        caption: 'Step deck trailer with lowered rear section'
    },
    'tanker-trailer': {
        image: '/static/images/tanker.jpeg',
        caption: 'Tanker trailer for liquid cargo'
    },
    'box-truck': {
        image: '/static/images/box_truck.jpeg',
        caption: 'Box truck for local and regional deliveries'
    }
};

// Populate image popups for equipment terms
Object.keys(equipmentImages).forEach(termId => {
    const termElement = document.getElementById(termId);
    if (termElement) {
        const popup = termElement.querySelector('.term-image-popup');
        const imgData = equipmentImages[termId];

        termElement.classList.add('has-image');
        popup.innerHTML = `
            <img src="${imgData.image}" alt="${imgData.caption}">
            <div class="image-caption">${imgData.caption}</div>
        `;
    }
});

searchBox.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    let visibleCount = 0;

    allTerms.forEach(term => {
        const searchData = term.getAttribute('data-search');
        if (searchData.includes(searchTerm)) {
            term.style.display = 'block';
            visibleCount++;
        } else {
            term.style.display = 'none';
        }
    });

    if (visibleCount === 0) {
        glossaryGrid.style.display = 'none';
        noResults.style.display = 'block';
    } else {
        glossaryGrid.style.display = 'flex';
        noResults.style.display = 'none';
    }

    termCount.textContent = visibleCount;
});

// Scroll to and highlight term if arriving from a link with hash
document.addEventListener('DOMContentLoaded', function() {
    if (window.location.hash) {
        const termId = window.location.hash.substring(1);
        const targetTerm = document.getElementById(termId);

        if (targetTerm) {
            // If this term has an image, show it expanded
            if (targetTerm.classList.contains('has-image')) {
                targetTerm.classList.add('image-expanded');
            }

            // Scroll to the term with some offset for the header
            setTimeout(function() {
                targetTerm.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Highlight the term temporarily
                targetTerm.style.borderLeftColor = 'var(--accent)';
                targetTerm.style.background = 'var(--warning-light)';
                targetTerm.style.transform = 'translateX(8px)';

                // Remove highlight after 3 seconds (keep image visible)
                setTimeout(function() {
                    targetTerm.style.borderLeftColor = '';
                    targetTerm.style.background = '';
                    targetTerm.style.transform = '';
                }, 3000);
            }, 100);
        }
    }
});
</script>
{% endblock %}
